<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Eduva - Teacher Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #e3f2fd; min-height: 100vh; }
        .edu-brand { font-weight: 700; color: #3b82f6; }
        .nav-tab.active { color: #3b82f6; border-bottom-color: #3b82f6; font-weight: 600; }
        .tab-scroll::-webkit-scrollbar { height: 4px; }
        .tab-scroll::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 2px; }
        .tab-scroll::-webkit-scrollbar-track { background: #f3f4f6; }
        .class-select-active { border-color: #3b82f6 !important; box-shadow: 0 0 0 4px rgba(59,130,246,0.15) !important; }
        .modal-bg { background-color: rgba(0,0,0,0.55); backdrop-filter: blur(3px); }
    </style>
</head>
<body class="transition-opacity duration-300" id="main-body">

    <div id="loading-screen" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-500"></div>
        <p class="mt-4 text-gray-600 font-medium">Checking authentication...</p>
    </div>

    <div id="dashboard-container" class="hidden">
        <header class="bg-white shadow-lg p-4 flex justify-between items-center sticky top-0 z-20">
            <div class="flex items-center">
                <i data-lucide="graduation-cap" class="w-7 h-7 text-blue-600 mr-2"></i>
                <span class="text-xl edu-brand">Eduva</span>
            </div>

            <div class="flex items-center space-x-4 text-sm font-medium text-gray-700">
                <p class="text-sm text-gray-500 hidden md:block">Welcome, <span id="teacher-name" class="font-semibold text-gray-700">Dr. Jane Doe (teacher)</span></p>
                <button id="exit-button" class="flex items-center bg-red-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-red-600 transition duration-150 shadow-md">
                    <i data-lucide="log-out" class="w-4 h-4 mr-1"></i> Logout
                </button>
            </div>
        </header>

        <main class="p-4 md:p-8">
            <h1 class="text-3xl font-extrabold text-gray-900 mb-8">Teacher Dashboard</h1>

            <div class="mb-8 p-6 bg-white rounded-2xl shadow-xl border border-gray-100 relative">
                <h2 class="text-lg font-bold text-gray-700 mb-4 flex items-center">
                    <i data-lucide="layout-grid" class="w-5 h-5 text-gray-500 mr-2"></i> Choose Class / Semester
                </h2>

                <div class="relative">
                    <select id="class-semester-select"
                            class="block w-full py-3 pl-4 pr-10 border-2 border-gray-300 rounded-2xl bg-white text-gray-800 font-medium focus:ring-4 focus:ring-blue-200 focus:border-blue-500 appearance-none transition duration-300 shadow-lg hover:border-blue-400 cursor-pointer">
                        </select>
                    <i data-lucide="chevron-down" class="w-5 h-5 absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 pointer-events-none"></i>
                </div>

                <div class="absolute right-4 top-4">
                    <button id="manage-classes-button" class="flex items-center space-x-2 text-sm bg-blue-600 text-white py-2 px-3 rounded-lg hover:bg-blue-700 transition">
                        <i data-lucide="settings" class="w-4 h-4"></i>
                        <span>Manage Classes</span>
                    </button>
                </div>
            </div>

            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl border border-gray-100">
                <div class="flex border-b border-gray-200 mb-6 space-x-8 overflow-x-auto tab-scroll text-base font-medium">
                    <button data-view="syllabus" class="nav-tab flex items-center py-3 px-1 text-gray-600 border-b-4 border-transparent hover:border-blue-300 transition-colors duration-200 active">
                        <i data-lucide="book" class="w-5 h-5 mr-2"></i> Syllabus
                    </button>
                    <button data-view="tracker" class="nav-tab flex items-center py-3 px-1 text-gray-600 border-b-4 border-transparent hover:border-blue-300 transition-colors duration-200">
                        <i data-lucide="calendar" class="w-5 h-5 mr-2"></i> Daily Tracker
                    </button>
                    <button data-view="assignments" class="nav-tab flex items-center py-3 px-1 text-gray-600 border-b-4 border-transparent hover:border-blue-300 transition-colors duration-200">
                        <i data-lucide="clipboard-list" class="w-5 h-5 mr-2"></i> Assignments
                    </button>
                    <button data-view="feedback" class="nav-tab flex items-center py-3 px-1 text-gray-600 border-b-4 border-transparent hover:border-blue-300 transition-colors duration-200">
                        <i data-lucide="message-square" class="w-5 h-5 mr-2"></i> Feedback
                    </button>
                </div>

                <div id="dashboard-content">
                    <div id="syllabus-view" class="content-view">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-3xl font-bold text-gray-900">Syllabus Management</h2>
                            <button id="add-subject-button" class="flex items-center bg-blue-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-blue-700 transition-all duration-200 shadow-md transform hover:scale-[1.02]">
                                <i data-lucide="plus" class="w-5 h-5 mr-1"></i> Add Subject
                            </button>
                        </div>

                        <div id="subject-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            </div>
                    </div>

                    <div id="tracker-view" class="content-view hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-3xl font-bold text-gray-900">Daily Progress Tracker</h2>
                            <button id="add-tracker-button" class="flex items-center bg-green-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-green-700 transition-all duration-200 shadow-md transform hover:scale-[1.02]">
                                <i data-lucide="plus" class="w-5 h-5 mr-1"></i> Add Today's Entry
                            </button>
                        </div>
                        <div id="tracker-entries" class="space-y-6">
                            </div>
                    </div>

                    <div id="assignments-view" class="content-view hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-3xl font-bold text-gray-900">Assignments & Quizzes</h2>
                            <button id="create-assignment-button" class="flex items-center bg-purple-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-purple-700 transition-all duration-200 shadow-md transform hover:scale-[1.02]">
                                <i data-lucide="plus" class="w-5 h-5 mr-1"></i> Create New
                            </button>
                        </div>
                        <div id="assignment-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            </div>
                    </div>

                    <div id="feedback-view" class="content-view hidden">
                        <h2 class="text-3xl font-bold text-gray-900">Student Feedback</h2>
                        <p class="text-sm text-gray-600 mt-4">Feedback UI (kept as placeholder here).</p>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <div id="manage-classes-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-bg p-4">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold">Manage Classes & Semesters</h3>
          <button onclick="closeManageClassesModal()" class="p-2 rounded-full text-gray-500 hover:bg-gray-100">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Add New Class / Semester</label>
          <div class="flex gap-3">
            <input id="new-class-input" type="text" class="flex-1 p-3 border border-gray-300 rounded-lg" placeholder="e.g., B.TECH CSE - Sem II">
            <button onclick="addClassConfirm()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Add</button>
          </div>
        </div>

        <div>
          <p class="text-sm font-semibold text-gray-700 mb-2">Existing Classes</p>
          <ul id="class-list" class="space-y-2 max-h-48 overflow-auto pr-2">
            </ul>
        </div>
      </div>
    </div>

    <div id="add-subject-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-bg p-4">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-gray-800">Add New Subject</h3>
          <button onclick="hideAddSubjectModal()" class="p-2 rounded-full text-gray-500 hover:bg-gray-100">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>

        <form id="add-subject-form">
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Subject Name</label>
            <input id="subject-name" type="text" class="w-full p-3 border border-gray-300 rounded-xl" placeholder="e.g., Mathematics" required>
          </div>
          <div class="flex justify-end gap-3">
            <button type="button" onclick="hideAddSubjectModal()" class="px-4 py-2 bg-gray-200 rounded-lg">Cancel</button>
            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Add Subject</button>
          </div>
        </form>
      </div>
    </div>

    <div id="add-topic-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-bg p-4">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-gray-800">Add Topic</h3>
          <button onclick="hideAddTopicModal()" class="p-2 rounded-full text-gray-500 hover:bg-gray-100">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>

        <div class="mb-3">
          <label class="block text-sm font-medium text-gray-700 mb-1">Select Subject</label>
          <select id="topic-subject-select" class="w-full p-3 border border-gray-300 rounded-lg">
            </select>
        </div>
        <div class="mb-3">
          <label class="block text-sm font-medium text-gray-700 mb-1">Topic Title</label>
          <input id="topic-title" type="text" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="e.g., Calculus - Derivatives">
        </div>
        <div class="mb-3">
          <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
          <input id="topic-desc" type="text" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Short description">
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">Duration</label>
          <input id="topic-duration" type="text" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="e.g., 4 hours">
        </div>

        <div class="flex justify-end gap-3">
          <button onclick="hideAddTopicModal()" class="px-4 py-2 bg-gray-200 rounded-lg">Cancel</button>
          <button onclick="confirmAddTopic()" class="px-4 py-2 bg-green-600 text-white rounded-lg">Add Topic</button>
        </div>
      </div>
    </div>
    
    <div id="create-assignment-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-bg p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Create New Assignment/Quiz</h3>
                <button onclick="hideCreateAssignmentModal()" class="p-2 rounded-full text-gray-500 hover:bg-gray-100">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <form id="create-assignment-form">
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    <input id="assignment-title" type="text" class="w-full p-3 border border-gray-300 rounded-xl" placeholder="e.g., Calculus Problem Set 1" required>
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                    <select id="assignment-type" class="w-full p-3 border border-gray-300 rounded-xl" required>
                        <option value="ASSIGNMENT">Assignment</option>
                        <option value="QUIZ">Quiz</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Subject</label>
                    <input id="assignment-subject" type="text" class="w-full p-3 border border-gray-300 rounded-xl" placeholder="e.g., Mathematics" required>
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="assignment-desc" rows="2" class="w-full p-3 border border-gray-300 rounded-xl" placeholder="Instructions/Description" required></textarea>
                </div>
                <div class="mb-3 flex gap-4">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Total Marks</label>
                        <input id="assignment-marks" type="number" class="w-full p-3 border border-gray-300 rounded-xl" placeholder="e.g., 50" required>
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                        <input id="assignment-due" type="date" class="w-full p-3 border border-gray-300 rounded-xl" required>
                    </div>
                </div>
                
                <div class="flex justify-end gap-3 mt-4">
                    <button type="button" onclick="hideCreateAssignmentModal()" class="px-4 py-2 bg-gray-200 rounded-lg">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg">Create</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="add-tracker-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-bg p-4">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-gray-800">Add Daily Progress Entry</h3>
          <button onclick="hideAddTrackerModal()" class="p-2 rounded-full text-gray-500 hover:bg-gray-100">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>

        <form id="add-tracker-form">
            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                <input id="tracker-date" type="date" class="w-full p-3 border border-gray-300 rounded-xl" required>
            </div>
            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Subject</label>
                <input id="tracker-subject" type="text" class="w-full p-3 border border-gray-300 rounded-xl" placeholder="e.g., Mathematics" required>
            </div>
            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Topics Covered (comma-separated)</label>
                <input id="tracker-topics" type="text" class="w-full p-3 border border-gray-300 rounded-xl" placeholder="e.g., Derivatives, Chain Rule" required>
            </div>
            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Notes & Observations</label>
                <textarea id="tracker-notes" rows="3" class="w-full p-3 border border-gray-300 rounded-xl" placeholder="e.g., Students struggled with chain rule applications..." required></textarea>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Students Present</label>
                <input id="tracker-students" type="number" class="w-full p-3 border border-gray-300 rounded-xl" placeholder="e.g., 28" required>
            </div>

            <div class="flex justify-end gap-3 mt-4">
              <button type="button" onclick="hideAddTrackerModal()" class="px-4 py-2 bg-gray-200 rounded-lg">Cancel</button>
              <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg">Add Entry</button>
            </div>
        </form>
      </div>
    </div>


    <div id="custom-alert-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-bg p-4">
      <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6">
        <h4 id="alert-title" class="text-lg font-bold text-blue-600 mb-3">Confirmation</h4>
        <p id="alert-message" class="text-gray-700 mb-6"></p>
        <button id="close-alert-button" class="w-full bg-blue-600 text-white py-2 rounded-lg">OK</button>
      </div>
    </div>

<script type="module">
  // -------------------------
  // GLOBAL STATE
  // -------------------------
  // Use a map to hold class-specific data
  let currentClassId = 1; // Default selected class
  
  // Structure: { classId: { subjects: [], assignments: [], tracker: [] } }
  let classData = {
    1: { // B.TECH CSE - Sem II
      subjects: [
        {
          id: 1,
          name: "Mathematics",
          topics: [
            { id: 1, title: "Calculus - Derivatives", description: "Introduction to derivatives and their applications", duration: "4 hours", completed: true },
            { id: 2, title: "Calculus - Integrals", description: "Integration techniques and applications", duration: "6 hours", completed: false },
            { id: 3, title: "Linear Algebra", description: "Matrices, vectors, and linear transformations", duration: "8 hours", completed: false }
          ]
        },
        {
          id: 2,
          name: "Physics",
          topics: [
            { id: 4, title: "Electromagnetic Waves", description: "Properties and behavior of electromagnetic radiation", duration: "5 hours", completed: true },
            { id: 5, title: "Quantum Mechanics", description: "Introduction to quantum theory", duration: "10 hours", completed: false }
          ]
        }
      ],
      assignments: [
        {
          id: 101, title: "Calculus Problem Set 1", type: "ASSIGNMENT", subject: "Mathematics",
          description: "Solve problems related to derivatives and their applications",
          marks: 50, due: "2025-01-25", totalStudents: 30, submitted: 22
        },
        {
          id: 102, title: "Wave Physics Quiz", type: "QUIZ", subject: "Physics",
          description: "Multiple choice quiz on electromagnetic wave properties",
          marks: 25, due: "2025-01-24", totalStudents: 30, submitted: 28
        }
      ],
      tracker: [
        {
          id: 201, date: "2025-01-22", subject: "Mathematics", studentsPresent: 28,
          topicsCovered: ["Derivatives", "Chain Rule"],
          notes: "Students struggled with chain rule applications. Need more practice examples.",
          notesFile: "math_notes_jan22.pdf"
        },
        {
          id: 202, date: "2025-01-21", subject: "Physics", studentsPresent: 30,
          topicsCovered: ["Electromagnetic Waves"],
          notes: "Excellent engagement. Students understood wave properties well.",
          notesFile: null
        }
      ]
    },
    2: { // B.TECH CSE AIML - Sem II (Placeholder Data)
        subjects: [{ id: 3, name: "AI Fundamentals", topics: [] }],
        assignments: [],
        tracker: [{
          id: 203, date: "2025-02-01", subject: "AI Fundamentals", studentsPresent: 25,
          topicsCovered: ["Introduction to ML", "Supervised Learning"],
          notes: "Fast learners. Plan a coding assignment for next week.",
          notesFile: null
        }]
    },
    3: { // B.TECH CSE - Sem IV (Empty Data)
        subjects: [],
        assignments: [],
        tracker: []
    },
    4: { // B.TECH CSE AIML - Sem IV (Empty Data)
        subjects: [],
        assignments: [],
        tracker: []
    }
  };

  let classes = [
    { id: 1, label: "B.TECH CSE - Sem II", totalStudents: 30 },
    { id: 2, label: "B.TECH CSE AIML - Sem II", totalStudents: 25 },
    { id: 3, label: "B.TECH CSE - Sem IV", totalStudents: 32 },
    { id: 4, label: "B.TECH CSE AIML - Sem IV", totalStudents: 28 }
  ];

  // -------------------------
  // DATA ACCESSORS
  // -------------------------
  function getCurrentData() {
    return classData[currentClassId] || { subjects: [], assignments: [], tracker: [] };
  }
  
  function getClasses() {
      return classes;
  }

  // -------------------------
  // RENDER / UI HELPERS
  // -------------------------
  function renderClassSelect() {
    const select = document.getElementById('class-semester-select');
    select.innerHTML = '';
    
    // Add placeholder option
    const placeholder = document.createElement('option');
    placeholder.value = '';
    placeholder.disabled = true;
    placeholder.textContent = "Select a Class and Semester";
    select.appendChild(placeholder);
    
    // Add class options
    classes.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.label;
      opt.textContent = c.label;
      opt.dataset.id = c.id;
      opt.selected = c.id === currentClassId;
      select.appendChild(opt);
    });

    // Manually trigger the select active styling for the initial state
    if (currentClassId) {
        select.classList.add('class-select-active');
    } else {
        select.classList.remove('class-select-active');
        select.selectedIndex = 0; // Select placeholder if no class is active
    }
  }

  function renderClassListInModal() {
    const list = document.getElementById('class-list');
    list.innerHTML = '';
    classes.forEach(c => {
      const li = document.createElement('li');
      li.className = "flex items-center justify-between bg-gray-50 p-3 rounded-lg";
      li.innerHTML = `
        <div class="text-sm text-gray-800">${c.label}</div>
        <div class="flex items-center gap-2">
          <button class="text-sm text-gray-500 hover:text-red-600" onclick="deleteClass(${c.id})" title="Delete Class">
            <i data-lucide="trash-2" class="w-4 h-4"></i>
          </button>
        </div>
      `;
      list.appendChild(li);
    });
    if (typeof lucide !== 'undefined' && lucide.createIcons) lucide.createIcons();
  }
  
  // --- SYLLABUS RENDER ---
  function renderSubjects() {
    const container = document.getElementById('subject-list');
    const { subjects } = getCurrentData();
    container.innerHTML = '';

    if (subjects.length === 0) {
      container.innerHTML = '<div class="col-span-2 text-center py-12"><p class="text-gray-500 text-lg">No subjects added yet. Click "Add Subject" to get started!</p></div>';
      return;
    }

    subjects.forEach(subject => {
      const card = document.createElement('div');
      card.className = "bg-white p-6 rounded-xl shadow-lg border border-gray-200";

      const topicsHtml = subject.topics.map(topic => `
        <div class="bg-gray-50 p-4 rounded-lg">
          <div class="flex items-start space-x-3">
            <button class="w-5 h-5 ${topic.completed ? 'bg-green-500' : 'border-2 border-gray-300'} rounded-full flex items-center justify-center mt-1 transition cursor-pointer" onclick="toggleTopicCompletion(${subject.id}, ${topic.id})">
              ${topic.completed ? '<i data-lucide="check" class="w-3 h-3 text-white"></i>' : ''}
            </button>
            <div class="flex-1">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <h4 class="font-semibold ${topic.completed ? 'text-green-600 line-through' : 'text-gray-800'}" onclick="toggleTopicCompletion(${subject.id}, ${topic.id})">${topic.title}</h4>
                  <p class="text-sm text-gray-600 mt-1">${topic.description}</p>
                  <p class="text-xs text-gray-500 mt-1">${topic.duration}</p>
                </div>
                <button class="text-red-500 hover:text-red-700 transition ml-2" onclick="deleteTopic(${subject.id}, ${topic.id})" title="Delete topic">
                  <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      `).join('');

      card.innerHTML = `
        <div class="flex justify-between items-center mb-4 border-b pb-3">
          <div class="flex items-center space-x-2">
            <i data-lucide="book" class="w-6 h-6 text-blue-500"></i>
            <h3 class="text-xl font-bold text-gray-800">${subject.name}</h3>
          </div>
          <div class="flex space-x-2">
            <button class="text-blue-500 hover:text-blue-700 transition" onclick="openAddTopicModal(${subject.id})" title="Add topic">
              <i data-lucide="plus" class="w-5 h-5"></i>
            </button>
            <button class="text-red-500 hover:text-red-700 transition" onclick="deleteSubject(${subject.id})" title="Delete subject">
              <i data-lucide="trash-2" class="w-5 h-5"></i>
            </button>
          </div>
        </div>
        <div class="space-y-3">
          ${topicsHtml}
          ${subject.topics.length === 0 ? '<p class="text-gray-500 text-sm italic text-center py-4">No topics added yet. Click the + button to add topics.</p>' : ''}
        </div>
      `;
      container.appendChild(card);
    });

    if (typeof lucide !== 'undefined' && lucide.createIcons) lucide.createIcons();
  }

  // --- ASSIGNMENT RENDER ---
  function renderAssignments() {
    const container = document.getElementById('assignment-list');
    const { assignments } = getCurrentData();
    container.innerHTML = '';
    
    if (assignments.length === 0) {
        container.innerHTML = '<div class="col-span-2 text-center py-12"><p class="text-gray-500 text-lg">No assignments/quizzes created for this class yet. Click "Create New" to get started!</p></div>';
        return;
    }

    assignments.forEach(a => {
        const submittedPercent = a.totalStudents > 0 ? Math.round((a.submitted / a.totalStudents) * 100) : 0;
        const progressBarColor = submittedPercent >= 75 ? 'bg-green-500' : submittedPercent >= 50 ? 'bg-yellow-500' : 'bg-red-500';
        const icon = a.type === 'ASSIGNMENT' ? 'clipboard' : 'file-question';
        const typeColor = a.type === 'ASSIGNMENT' ? 'bg-blue-100 text-blue-800' : 'bg-red-100 text-red-800';

        const card = document.createElement('div');
        card.className = 'bg-white p-6 rounded-xl shadow-lg border border-gray-200 transition-shadow hover:shadow-xl relative';
        card.innerHTML = `
            <div class="flex justify-between items-start mb-3">
                <div class="flex items-center space-x-2">
                    <i data-lucide="${icon}" class="w-6 h-6 text-gray-500"></i>
                    <h4 class="text-lg font-semibold text-gray-800">${a.title}</h4>
                </div>
                <div class="text-sm font-semibold text-red-600">Due: ${new Date(a.due).toLocaleDateString('en-US', { year: 'numeric', month: 'numeric', day: 'numeric' })}</div>
            </div>
            
            <p class="text-sm font-medium text-gray-600 mb-2">${a.subject}</p>
            <span class="text-xs font-semibold ${typeColor} px-2.5 py-0.5 rounded-full">${a.type}</span>
            <p class="text-sm text-gray-700 mt-3">${a.description}</p>
            
            <div class="mt-4">
                <p class="text-sm font-medium text-gray-700">${a.marks} marks</p>
                <div class="flex justify-between items-end mt-2">
                    <p class="text-sm text-gray-600">${a.submitted}/${a.totalStudents} submitted (${submittedPercent}%)</p>
                    <button class="text-red-500 hover:text-red-700 transition" onclick="deleteAssignment(${a.id})" title="Delete Assignment">
                      <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5 mt-1">
                    <div class="h-2.5 rounded-full ${progressBarColor}" style="width: ${submittedPercent}%"></div>
                </div>
            </div>
            
            <div class="flex space-x-3 mt-5">
                <button class="flex-1 flex items-center justify-center bg-blue-600 text-white py-2 rounded-lg font-medium hover:bg-blue-700 transition">
                    <i data-lucide="eye" class="w-4 h-4 mr-1"></i> View Submissions
                </button>
                <button class="flex-1 flex items-center justify-center bg-gray-200 text-gray-800 py-2 rounded-lg font-medium hover:bg-gray-300 transition">
                    <i data-lucide="upload-cloud" class="w-4 h-4 mr-1"></i> Upload File
                </button>
            </div>
        `;
        container.appendChild(card);
    });
    if (typeof lucide !== 'undefined' && lucide.createIcons) lucide.createIcons();
  }
  
  // --- TRACKER RENDER ---
  function renderTrackerEntries() {
      const container = document.getElementById('tracker-entries');
      const { tracker } = getCurrentData();
      const currentClass = getClasses().find(c => c.id === currentClassId);
      container.innerHTML = '';
      
      if (tracker.length === 0) {
          container.innerHTML = '<div class="text-center py-12"><p class="text-gray-500 text-lg">No daily progress entries for this class yet. Click "Add Today\'s Entry" to get started!</p></div>';
          return;
      }
      
      // Sort by date descending
      const sortedTracker = [...tracker].sort((a, b) => new Date(b.date) - new Date(a.date));

      sortedTracker.forEach(t => {
          const topicsHtml = t.topicsCovered.map(topic => `
              <li class="flex items-center text-sm text-gray-700">
                  <i data-lucide="check-circle" class="w-4 h-4 text-green-500 mr-2 flex-shrink-0"></i> ${topic}
              </li>
          `).join('');
          
          const entryDate = new Date(t.date).toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: 'numeric' });

          const card = document.createElement('div');
          card.className = 'bg-white p-6 rounded-xl shadow-md border border-gray-100 relative';
          card.innerHTML = `
            <div class="flex justify-between items-start mb-4 border-b pb-3">
                <div class="flex items-center space-x-3">
                    <i data-lucide="calendar" class="w-6 h-6 text-blue-500"></i>
                    <div>
                        <h4 class="text-xl font-bold text-gray-800">${t.subject}</h4>
                        <p class="text-sm text-gray-500">${entryDate}</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600 flex items-center">
                        <i data-lucide="users" class="w-4 h-4 text-gray-500 mr-1"></i> ${t.studentsPresent} students
                    </span>
                    <button class="text-red-500 hover:text-red-700 transition" onclick="deleteTrackerEntry(${t.id})" title="Delete Entry">
                      <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h5 class="text-base font-semibold text-gray-800 mb-2">Topics Covered</h5>
                    <ul class="space-y-1">
                        ${topicsHtml}
                    </ul>
                </div>
                <div>
                    <h5 class="text-base font-semibold text-gray-800 mb-2">Notes & Observations</h5>
                    <p class="text-sm text-gray-700">${t.notes}</p>
                    ${t.notesFile ? `
                        <a href="#" class="text-sm text-blue-600 hover:text-blue-800 flex items-center mt-2">
                            <i data-lucide="file-text" class="w-4 h-4 mr-1"></i> ${t.notesFile}
                        </a>
                    ` : ''}
                </div>
            </div>
            
            <button class="text-sm text-blue-600 hover:text-blue-800 flex items-center mt-4">
                <i data-lucide="upload-cloud" class="w-4 h-4 mr-1"></i> Upload Notes File
            </button>
          `;
          container.appendChild(card);
      });
      if (typeof lucide !== 'undefined' && lucide.createIcons) lucide.createIcons();
  }

  // -------------------------
  // CLASS MANAGEMENT LOGIC
  // -------------------------
  function openManageClassesModal() {
    document.getElementById('manage-classes-modal').classList.remove('hidden');
    renderClassListInModal();
  }
  function closeManageClassesModal() {
    document.getElementById('manage-classes-modal').classList.add('hidden');
    document.getElementById('new-class-input').value = '';
  }
  function addClassConfirm() {
    const label = document.getElementById('new-class-input').value.trim();
    if (!label) return;
    const newId = Date.now();
    
    // Add to classes array
    classes.push({ id: newId, label: label, totalStudents: 30 }); // Default students to 30
    
    // Initialize data structure for the new class
    classData[newId] = { subjects: [], assignments: [], tracker: [] };
    
    renderClassSelect();
    renderClassListInModal();
    document.getElementById('new-class-input').value = '';
  }
  function deleteClass(id) {
    if (!confirm('Delete this class? This will also delete all associated Syllabus, Assignments, and Tracker data!')) return;
    
    // Remove from classes array
    classes = classes.filter(c => c.id !== id);
    
    // Remove from classData structure
    delete classData[id];
    
    // Update currentClassId if the deleted class was active
    if (currentClassId === id) {
        currentClassId = classes.length > 0 ? classes[0].id : null;
    }
    
    renderClassSelect();
    renderClassListInModal();
    renderAllContent(); // Re-render content for the new active class
  }
  
  function handleClassChange(e) {
      const select = e.target;
      const selectedOption = select.options[select.selectedIndex];
      const newClassId = parseInt(selectedOption.dataset.id);
      
      if (currentClassId !== newClassId) {
          currentClassId = newClassId;
          renderAllContent();
      }
      
      // Apply/remove active style
      if (select.value) select.classList.add('class-select-active');
      else select.classList.remove('class-select-active');
  }

  // -------------------------
  // CORE CONTENT LOGIC (SUBJECTS, ASSIGNMENTS, TRACKER)
  // -------------------------
  
  function renderAllContent() {
      // Calls all render functions based on the currentClassId
      renderSubjects();
      renderAssignments();
      renderTrackerEntries();
      if (typeof lucide !== 'undefined' && lucide.createIcons) lucide.createIcons();
  }

  // --- SYLLABUS LOGIC ---

  function showAddSubjectModal() { document.getElementById('add-subject-modal').classList.remove('hidden'); }
  function hideAddSubjectModal() { document.getElementById('add-subject-modal').classList.add('hidden'); document.getElementById('subject-name').value = ''; }

  function openAddTopicModal(subjectId) {
    document.getElementById('add-topic-modal').classList.remove('hidden');
    // populate subject select with current class's subjects
    const sel = document.getElementById('topic-subject-select');
    sel.innerHTML = '';
    getCurrentData().subjects.forEach(s => {
      const opt = document.createElement('option'); opt.value = s.id; opt.textContent = s.name; sel.appendChild(opt);
    });
    // set selected subject
    sel.value = subjectId;
  }
  function hideAddTopicModal() {
    document.getElementById('add-topic-modal').classList.add('hidden');
    document.getElementById('topic-title').value = '';
    document.getElementById('topic-desc').value = '';
    document.getElementById('topic-duration').value = '';
  }

  function deleteSubject(id) {
    if (!confirm('Delete this subject and all its topics?')) return;
    const data = getCurrentData();
    data.subjects = data.subjects.filter(s => s.id !== id);
    renderSubjects();
  }

  function deleteTopic(subjectId, topicId) {
    const data = getCurrentData();
    const subj = data.subjects.find(s => s.id === subjectId);
    if (!subj) return;
    subj.topics = subj.topics.filter(t => t.id !== topicId);
    renderSubjects();
  }

  function toggleTopicCompletion(subjectId, topicId) {
    const data = getCurrentData();
    const subj = data.subjects.find(s => s.id === subjectId);
    if (!subj) return;
    const topic = subj.topics.find(t => t.id === topicId);
    if (!topic) return;
    topic.completed = !topic.completed;
    renderSubjects();
  }

  // add subject (from modal)
  document.getElementById('add-subject-button').addEventListener('click', showAddSubjectModal);
  document.getElementById('add-subject-form').addEventListener('submit', function(e){
    e.preventDefault();
    const name = document.getElementById('subject-name').value.trim();
    if (!name) return;
    getCurrentData().subjects.push({ id: Date.now(), name, topics: [] });
    hideAddSubjectModal();
    renderSubjects();
  });

  // Add topic from modal confirmation
  function confirmAddTopic() {
    const subjId = parseInt(document.getElementById('topic-subject-select').value);
    const title = document.getElementById('topic-title').value.trim();
    const desc = document.getElementById('topic-desc').value.trim();
    const dur = document.getElementById('topic-duration').value.trim();
    if (!subjId || !title || !desc || !dur) return;
    const subj = getCurrentData().subjects.find(s => s.id === subjId);
    subj.topics.push({ id: Date.now(), title, description: desc, duration: dur, completed: false });
    hideAddTopicModal();
    renderSubjects();
  }

  // --- ASSIGNMENTS LOGIC ---
  function showCreateAssignmentModal() { document.getElementById('create-assignment-modal').classList.remove('hidden'); }
  function hideCreateAssignmentModal() { 
    document.getElementById('create-assignment-modal').classList.add('hidden');
    document.getElementById('create-assignment-form').reset();
  }
  
  document.getElementById('create-assignment-button').addEventListener('click', showCreateAssignmentModal);
  document.getElementById('create-assignment-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const title = document.getElementById('assignment-title').value.trim();
      const type = document.getElementById('assignment-type').value;
      const subject = document.getElementById('assignment-subject').value.trim();
      const description = document.getElementById('assignment-desc').value.trim();
      const marks = parseInt(document.getElementById('assignment-marks').value);
      const due = document.getElementById('assignment-due').value;
      
      if (!title || !subject || !description || isNaN(marks) || !due) return;
      
      const currentClass = getClasses().find(c => c.id === currentClassId) || { totalStudents: 30 };

      const newAssignment = {
          id: Date.now(), title, type, subject, description, marks, due,
          totalStudents: currentClass.totalStudents,
          submitted: 0 // Always start with 0 submitted
      };
      
      getCurrentData().assignments.push(newAssignment);
      hideCreateAssignmentModal();
      renderAssignments();
  });
  
  function deleteAssignment(id) {
      if (!confirm('Delete this Assignment/Quiz?')) return;
      const data = getCurrentData();
      data.assignments = data.assignments.filter(a => a.id !== id);
      renderAssignments();
  }
  
  // --- TRACKER LOGIC ---
  function showAddTrackerModal() { document.getElementById('add-tracker-modal').classList.remove('hidden'); document.getElementById('tracker-date').valueAsDate = new Date(); }
  function hideAddTrackerModal() { 
    document.getElementById('add-tracker-modal').classList.add('hidden');
    document.getElementById('add-tracker-form').reset();
  }
  
  document.getElementById('add-tracker-button').addEventListener('click', showAddTrackerModal);
  document.getElementById('add-tracker-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const date = document.getElementById('tracker-date').value;
      const subject = document.getElementById('tracker-subject').value.trim();
      const topicsStr = document.getElementById('tracker-topics').value.trim();
      const notes = document.getElementById('tracker-notes').value.trim();
      const studentsPresent = parseInt(document.getElementById('tracker-students').value);
      
      if (!date || !subject || !topicsStr || !notes || isNaN(studentsPresent)) return;
      
      const topicsCovered = topicsStr.split(',').map(t => t.trim()).filter(t => t.length > 0);

      const newEntry = {
          id: Date.now(), date, subject, studentsPresent, topicsCovered, notes, notesFile: null
      };
      
      getCurrentData().tracker.push(newEntry);
      hideAddTrackerModal();
      renderTrackerEntries();
  });
  
  function deleteTrackerEntry(id) {
      if (!confirm('Delete this Daily Progress Entry?')) return;
      const data = getCurrentData();
      data.tracker = data.tracker.filter(t => t.id !== id);
      renderTrackerEntries();
  }
  
  // -------------------------
  // Alerts & small helpers
  // -------------------------
  function showAlert(title, message) {
    document.getElementById('alert-title').textContent = title;
    document.getElementById('alert-message').textContent = message;
    document.getElementById('custom-alert-modal').classList.remove('hidden');
  }
  document.getElementById('close-alert-button').addEventListener('click', () => {
    document.getElementById('custom-alert-modal').classList.add('hidden');
  });

  // -------------------------
  // Simple view nav (keeps same behavior)
  // -------------------------
  let currentView = 'syllabus';
  function renderView() {
    document.querySelectorAll('.content-view').forEach(v => v.classList.add('hidden'));
    document.getElementById(currentView + '-view').classList.remove('hidden');
    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.classList.toggle('active', tab.dataset.view === currentView);
    });
    if (typeof lucide !== 'undefined' && lucide.createIcons) lucide.createIcons();
    
    // Ensure content is rendered when view changes
    if (currentView === 'syllabus') renderSubjects();
    else if (currentView === 'assignments') renderAssignments();
    else if (currentView === 'tracker') renderTrackerEntries();
  }
  document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      currentView = tab.dataset.view;
      renderView();
    });
  });

  // Manage classes button
  document.getElementById('manage-classes-button').addEventListener('click', openManageClassesModal);

  // When select changes, handle class change and add class-select-active
  document.addEventListener('change', (e) => {
    if (e.target && e.target.id === 'class-semester-select') {
      handleClassChange(e);
    }
  });

  // -------------------------
  // INIT
  // -------------------------
  function initApp() {
    // expose functions to global scope for use in inline event handlers (like onclick)
    window.confirmAddTopic = confirmAddTopic;
    window.openAddTopicModal = openAddTopicModal;
    window.deleteTopic = deleteTopic;
    window.deleteSubject = deleteSubject;
    window.toggleTopicCompletion = toggleTopicCompletion;
    window.deleteAssignment = deleteAssignment;
    window.deleteTrackerEntry = deleteTrackerEntry;
    window.closeManageClassesModal = closeManageClassesModal;
    window.addClassConfirm = addClassConfirm;
    window.deleteClass = deleteClass;
    window.hideAddSubjectModal = hideAddSubjectModal;
    window.hideAddTopicModal = hideAddTopicModal;
    window.hideCreateAssignmentModal = hideCreateAssignmentModal;
    window.hideAddTrackerModal = hideAddTrackerModal;
    
    // Initial Setup
    document.getElementById('loading-screen').classList.add('hidden');
    document.getElementById('dashboard-container').classList.remove('hidden');

    // teacher name (fallback)
    let teacherEmail = localStorage.getItem('userEmail') || 'dr.janedoe@eduva.com';
    let teacherName = teacherEmail.split('@')[0].replace(/\b\w/g, c => c.toUpperCase()).replace('.', ' ');
    document.getElementById('teacher-name').textContent = `${teacherName} (teacher)`;

    // render initial UI
    // Ensure we have a default class if the list isn't empty
    if (classes.length > 0 && currentClassId === null) {
        currentClassId = classes[0].id;
    }
    renderClassSelect();
    renderAllContent();
    renderView(); // Renders the default 'syllabus' view

    // attach basic listeners
    document.getElementById('exit-button').addEventListener('click', () => {
      localStorage.removeItem('userToken'); 
      localStorage.removeItem('userEmail'); 
      localStorage.removeItem('userRole');
      // Redirect to login page
      window.location.href = 'login.html';
    });

    // modal click outside listeners
    document.getElementById('manage-classes-modal').addEventListener('click', (e) => {
      if (e.target.id === 'manage-classes-modal') closeManageClassesModal();
    });
    document.getElementById('add-subject-modal').addEventListener('click', (e) => {
      if (e.target.id === 'add-subject-modal') hideAddSubjectModal();
    });
    document.getElementById('add-topic-modal').addEventListener('click', (e) => {
      if (e.target.id === 'add-topic-modal') hideAddTopicModal();
    });
    document.getElementById('create-assignment-modal').addEventListener('click', (e) => {
      if (e.target.id === 'create-assignment-modal') hideCreateAssignmentModal();
    });
    document.getElementById('add-tracker-modal').addEventListener('click', (e) => {
      if (e.target.id === 'add-tracker-modal') hideAddTrackerModal();
    });


    // final icons
    if (typeof lucide !== 'undefined' && lucide.createIcons) lucide.createIcons();
  }

  window.onload = initApp;

</script>
</body>
</html>

